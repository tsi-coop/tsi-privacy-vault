<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSI Privacy Vault - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --vault-primary: #0f172a; /* Slate 900 */
            --vault-accent: #6366f1;  /* Indigo 500 */
            --background: #f8fafc;
        }

        body {
            background-color: var(--background);
            font-family: ui-sans-serif, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background-color: var(--vault-primary);
            color: white;
            position: fixed;
            height: 100vh;
            z-index: 50;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: #94a3b8; /* Slate 400 */
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #1e293b;
            color: white;
            border-right: 4px solid var(--vault-accent);
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        @media (min-width: 1024px) {
            main { padding-left: 260px; }
        }
    </style>
</head>
<body class="flex">

<aside class="sidebar hidden lg:flex flex-col">
    <div class="p-8">
        <h2 class="text-lg font-black tracking-tighter uppercase leading-tight">TSI Privacy Vault</h2>
        <p class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em]">Secure Data Isolation</p>
    </div>
    
    <nav class="flex-1 mt-4">
        <a href="dashboard.html" class="nav-link active">ðŸ“Š Dashboard</a>
        <a href="entities.html" class="nav-link">ðŸ§¬ Entities</a>
        <a href="users.html" class="nav-link">ðŸ‘¥ Users</a>
        <a href="apikeys.html" class="nav-link">ðŸ”‘ API Keys</a>
        <a href="audit.html" class="nav-link">ðŸ“œ Audit</a>
        <a href="reports.html" class="nav-link">ðŸ“ˆ Reports</a>
    </nav>

    <div class="p-6 border-t border-slate-800">
        <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-xs" id="user-initials">AD</div>
            <div>
                <p class="text-xs font-bold" id="display-name">Admin User</p>
                <a href="#" onclick="handleLogout()" class="text-[10px] text-red-400 font-bold uppercase hover:underline">Sign Out</a>
            </div>
        </div>
    </div>
</aside>

<main class="flex-1 min-h-screen">
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-40">
        <h1 class="text-sm font-bold text-slate-500 uppercase tracking-widest">Vault Overview</h1>
        </header>

    <div class="p-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Records</p>
                <h3 class="text-3xl font-black text-slate-900" id="stat-records">...</h3>
            </div>
            <div class="card p-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Active API Keys</p>
                <h3 class="text-3xl font-black text-slate-900" id="stat-keys">...</h3>
            </div>
            <div class="card p-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Entity Flavors</p>
                <h3 class="text-3xl font-black text-slate-900" id="stat-flavors">...</h3>
            </div>
            <div class="card p-6 bg-red-50 border-red-100">
                <p class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-1">Auth Failures</p>
                <h3 class="text-3xl font-black text-red-600" id="stat-failures">...</h3>
            </div>
        </div>

        <div class="card">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="font-black text-slate-800 uppercase tracking-tighter">Live Audit Stream</h2>
                <a href="audit.html" class="text-[10px] font-black text-indigo-600 uppercase tracking-widest hover:underline">View Full Log</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <th class="px-6 py-4">Timestamp (IST)</th>
                            <th class="px-6 py-4">Actor</th>
                            <th class="px-6 py-4">Operation</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4">Machine ID</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table-body" class="text-sm">
                        <tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Initializing forensic tunnel...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
    const TOKEN = localStorage.getItem('vaultToken');
    const USERNAME = localStorage.getItem('username') || 'Admin';

    // Session Guard: Redirect if not logged in
    if (!TOKEN) window.location.href = 'index.html';

    document.getElementById('display-name').textContent = USERNAME;
    document.getElementById('user-initials').textContent = USERNAME.substring(0, 2).toUpperCase();

    async function loadDashboardData() {
        try {
            // Integration with Audit and Stats service
            const response = await fetch('api/admin/dashboard', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${TOKEN}`
                },
                body: JSON.stringify({ "_func": "get_dashboard_stats" })
            });

            const data = await response.json();

            if (response.ok) {
                // Update Metrics
                document.getElementById('stat-records').textContent = data.total_records.toLocaleString();
                document.getElementById('stat-keys').textContent = data.active_keys;
                document.getElementById('stat-flavors').textContent = data.entity_flavors;
                document.getElementById('stat-failures').textContent = data.auth_failures;

                // Render Live Audit Stream
                renderAuditTable(data.recent_logs);
            }
        } catch (err) {
            console.error("Failed to load vault stats", err);
        }
    }

    function renderAuditTable(logs) {
        const tbody = document.getElementById('audit-table-body');
        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center">No recent activity detected.</td></tr>';
            return;
        }

        tbody.innerHTML = logs.map(log => {
            const statusColor = log.outcome === 'SUCCESS' ? 'bg-green-500' : 'bg-red-500';
            const opColor = log.outcome === 'SUCCESS' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-600 bg-slate-100';
            
            return `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="px-6 py-4 font-mono text-[11px] text-slate-500">${log.timestamp}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${log.who}</td>
                    <td class="px-6 py-4"><span class="text-[10px] font-black ${opColor} px-2 py-0.5 rounded uppercase">${log.operation_type}</span></td>
                    <td class="px-6 py-4 flex items-center gap-2">
                        <span class="status-dot ${statusColor}"></span> <span class="text-xs font-bold text-slate-700">${log.outcome}</span>
                    </td>
                    <td class="px-6 py-4 font-mono text-[10px] text-slate-400">${log.machine_id}</td>
                </tr>
            `;
        }).join('');
    }

    function handleLogout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    // Auto-refresh every 30 seconds
    window.onload = loadDashboardData;
    setInterval(loadDashboardData, 30000);
</script>

</body>
</html>